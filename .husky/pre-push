#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo 'ğŸ” Checking branch protection...'

# Get the current branch
current_branch=$(git symbolic-ref --short HEAD 2>/dev/null)

# Get the remote branch being pushed to
remote_ref=$(git rev-parse --abbrev-ref --symbolic-full-name @{push} 2>/dev/null || echo "")
remote_branch=$(echo "$remote_ref" | sed 's/.*\///')

# If no remote branch detected, use the current branch name as target
if [ -z "$remote_branch" ]; then
  remote_branch="$current_branch"
fi

# Protected branches
protected_branches="master"

# Check if pushing to a protected branch
for branch in $protected_branches; do
  if [ "$remote_branch" = "$branch" ] || [ "$current_branch" = "$branch" ]; then
    echo "ğŸš« Direct push to '$branch' is not allowed!"
    echo "ğŸ“ Please create a Pull Request instead."
    echo ""
    exit 1
  fi
done

echo 'âœ… Branch check passed!'
echo 'ğŸš€ Running tests before push...'

# Run tests
bun run test ||
(
    echo ''
    echo 'âŒ Tests failed!'
    echo 'ğŸ”§ Please fix failing tests before pushing to remote.'
    echo ''
    exit 1
)

echo ''
echo 'âœ… All tests passed! Pushing to remote...'
echo ''
